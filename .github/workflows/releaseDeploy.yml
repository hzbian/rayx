name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container || '' }}

    strategy:
      matrix:
        include:
          - os: windows-2025
            build-type: Release

          - os: ubuntu-24.04
            build-type: Release

          - os: ubuntu-latest
            container: fedora:latest
            build-type: Release
            label: fedora

    steps:
      # ==========================================
      # Shared steps
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update all submodules
        run: |
          git submodule sync
          git submodule update --init --recursive

      # Vulkan dependencies (shared)
      - name: Prepare environment
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-query-version: 1.4.304.1
          vulkan-components: Vulkan-Headers, Vulkan-Loader, SPIRV-Tools, Glslang
          vulkan-use-cache: true

      # ==========================================
      # WINDOWS BUILD
      # ==========================================
      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-2025'
        run: |
          vcpkg install hdf5 --triplet x64-windows
          vcpkg integrate install
          echo "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\bin" >> $GITHUB_PATH
        shell: powershell

      - name: Install NSIS (Windows)
        if: matrix.os == 'windows-2025'
        run: choco install nsis -y

      - name: Setup CUDA Toolkit
        if: matrix.os == 'windows-2025'
        id: cuda-toolkit
        shell: pwsh
        run: .\Scripts\setup-cuda.ps1
        env:
          INPUT_CUDA_VERSION: 12.9.1

      - name: Configure CMake (Windows)
        if: matrix.os == 'windows-2025'
        run: cmake -B build -DRAYX_WERROR=ON -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
             -DRAYX_REQUIRE_CUDA=ON -DRAYX_REQUIRE_OPENMP=ON \
             -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/install

      # ==========================================
      # UBUNTU BUILD (DEB + TGZ only!)
      # ==========================================
      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-24.04'
        run: |
          sudo apt update --yes
          sudo apt install --yes xorg-dev cmake libgtk-3-dev libdbus-1-dev libhdf5-dev

      - name: Install Cuda (Ubuntu)
        if: matrix.os == 'ubuntu-24.04'
        uses: Jimver/cuda-toolkit@master
        id: cuda-toolkit-ubuntu
        with:
          cuda: '12.8.1'
          method: 'network'

      - name: Configure CMake (Ubuntu)
        if: matrix.os == 'ubuntu-24.04'
        run: cmake -B build -DRAYX_WERROR=ON -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
             -DRAYX_REQUIRE_CUDA=ON -DRAYX_REQUIRE_OPENMP=ON \
             -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/install

      # ==========================================
      # FEDORA BUILD (RPM + TGZ)
      # ==========================================
      - name: Detect Fedora version
        if: matrix.label == 'fedora'
        id: fedver
        run: |
          echo "fedora_version=$(rpm -E %fedora)" >> $GITHUB_ENV

      - name: Install dependencies (Fedora)
        if: matrix.label == 'fedora'
        run: |
          dnf -y upgrade
          dnf -y install cmake ninja-build gcc gcc-c++ \
                         hdf5 hdf5-devel \
                         xorg-x11-server-devel gtk3-devel dbus-devel

      - name: Configure CMake (Fedora)
        if: matrix.label == 'fedora'
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
            -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/install \
            -DHDF5_ROOT=/usr

      # ==========================================
      # Build (all Linux + Windows)
      # ==========================================
      - name: Build
        run: cmake --build build --config ${{ matrix.build-type }}

      - name: Test
        working-directory: build/bin/release
        run: ./rayx-core-tst -x

      # ==========================================
      # PACKAGING
      # ==========================================

      # Windows
      - name: CPack (Windows - ZIP)
        if: matrix.os == 'windows-2025'
        working-directory: build
        run: cpack -G ZIP

      - name: CPack (Windows - NSIS)
        if: matrix.os == 'windows-2025'
        working-directory: build
        run: cpack -G NSIS

      # Ubuntu — DEB + TGZ only
      - name: CPack (Ubuntu - DEB)
        if: matrix.os == 'ubuntu-24.04'
        working-directory: build
        run: cpack -G DEB

      - name: CPack (Ubuntu - TGZ)
        if: matrix.os == 'ubuntu-24.04'
        working-directory: build
        run: cpack -G TGZ

      # Fedora — RPM + TGZ with versioned filenames
      - name: CPack (Fedora - RPM)
        if: matrix.label == 'fedora'
        working-directory: build
        run: |
          cpack -G RPM
          mv RAYX-*.rpm RAYX-fedora${{ env.fedora_version }}.rpm

      - name: CPack (Fedora - TGZ)
        if: matrix.label == 'fedora'
        working-directory: build
        run: |
          cpack -G TGZ
          mv RAYX-*.tar.gz RAYX-fedora${{ env.fedora_version }}.tar.gz

      # ==========================================
      # ARTIFACT UPLOAD
      # ==========================================

      - name: Upload Windows artifacts
        if: matrix.os == 'windows-2025'
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            build/RAYX-*.zip
            build/RAYX-*.exe
          if-no-files-found: error

      - name: Upload Ubuntu artifacts
        if: matrix.os == 'ubuntu-24.04'
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-artifacts
          path: |
            build/RAYX-*.deb
            build/RAYX-*.tar.gz
          if-no-files-found: error

      - name: Upload Fedora artifacts
        if: matrix.label == 'fedora'
        uses: actions/upload-artifact@v4
        with:
          name: fedora-artifacts
          path: |
            build/RAYX-fedora*.rpm
            build/RAYX-fedora*.tar.gz
          if-no-files-found: error

      # ==========================================
      # VERSION + SOURCE ARCHIVE
      # ==========================================
      - name: Extract version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Archive source code
        run: git archive HEAD --format=zip --output=build/RAYX-source-v${{env.version}}.zip


  # ==========================================
  # RELEASE CREATION
  # ==========================================
  release:
    name: Create Release
    needs: build-and-release
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: CHANGELOG.md

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Create and Upload Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: CHANGELOG.md
          files: |
            artifacts/windows-artifacts/*.zip
            artifacts/windows-artifacts/*.exe
            artifacts/ubuntu-artifacts/*.deb
            artifacts/ubuntu-artifacts/*.tar.gz
            artifacts/fedora-artifacts/*.rpm
            artifacts/fedora-artifacts/*.tar.gz
            artifacts/ubuntu-artifacts/RAYX-source-v${{env.version}}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
